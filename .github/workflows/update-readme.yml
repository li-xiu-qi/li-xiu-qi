name: Update README with Top Starred Repos

on:
  push:
  schedule:
    - cron: "0 */1 * * *"  # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update README
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            // è·å–æ‰€æœ‰ owned repos å¹¶æŒ‰ star æ•°æ’åº
            let allRepos = [];
            let page = 1;
            const perPage = 100;
            while (true) {
              const { data: repos } = await github.rest.repos.listForUser({
                username: context.repo.owner,
                type: 'owner',
                per_page: perPage,
                page: page
              });
              allRepos = allRepos.concat(repos);
              if (repos.length < perPage) break;
              page++;
            }
            const repos = allRepos.sort((a, b) => b.stargazers_count - a.stargazers_count).slice(0, 10);

            let repoList = '## ğŸŒŸ Top Starred Repositories\n\n';
            repos.forEach(repo => {
              repoList += `- [${repo.name}](${repo.html_url}) - ${repo.description || 'No description'} (${repo.stargazers_count} stars)\n`;
            });

            // è¯»å–å½“å‰README
            const readmePath = 'README.md';
            let readmeContent = '';
            let readmeData;
            try {
              const { data: data } = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: readmePath
              });
              readmeData = data;
              readmeContent = Buffer.from(readmeData.content, 'base64').toString('utf-8');
            } catch (error) {
              console.log('README not found, creating new one');
            }

            // åˆ é™¤æ—§çš„åˆ—è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            readmeContent = readmeContent.replace(/## ğŸŒŸ Top Starred Repositories[\s\S]*?<!-- TOP-REPOS-LIST -->/g, '<!-- TOP-REPOS-LIST -->');

            // æ›¿æ¢æˆ–æ·»åŠ åˆ—è¡¨ï¼ˆå‡è®¾æœ‰å ä½ç¬¦<!-- TOP-REPOS-LIST -->ï¼‰
            const placeholder = '<!-- TOP-REPOS-LIST -->';
            if (readmeContent.includes(placeholder)) {
              readmeContent = readmeContent.replace(placeholder, repoList + '\n' + placeholder);
            } else {
              readmeContent += '\n' + repoList;
            }

            // å†™å…¥æ–°README
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: readmePath,
              message: 'Update top starred repos list',
              content: Buffer.from(readmeContent).toString('base64'),
              sha: readmeData ? readmeData.sha : undefined
            });

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Update README with top starred repos
          branch: main